<div id="sqlModuleContainer" class="flex flex-col gap-4 transition-all duration-300">
    <!-- SQL Editor Header -->
    <div class="flex justify-between items-end gap-4">
        <div>
            <label class="block text-slate-700 font-bold mb-2 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 9l3 3-3 3m5 0h3M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                </svg>
                SQL ç·¨è¼¯å™¨
            </label>
            <div class="text-sm text-slate-600 flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"/>
                </svg>
                å¿«æ·éµ: <kbd class="px-2 py-1 bg-slate-200 rounded text-sm">Ctrl</kbd> + <kbd class="px-2 py-1 bg-slate-200 rounded text-sm">Enter</kbd> åŸ·è¡Œ
            </div>
        </div>
        <div class="flex gap-2 shadow-sm">
            <button class="px-3 py-2 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-1 text-sm font-bold"
                    onclick="document.getElementById('sqlFileInput').click()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19a2 2 0 01-2-2V7a2 2 0 012-2h4l2 3h4a2 2 0 012 2v5a2 2 0 01-2 2H9z"/>
                </svg>
                è¼‰å…¥æª”æ¡ˆ
            </button>
            <button class="px-3 py-2 border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-100 transition-colors flex items-center gap-1 text-sm font-bold" onclick="clearEditor()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                æ¸…é™¤
            </button>
            <button class="px-3 py-2 border border-slate-300 text-teal-600 rounded-lg hover:bg-teal-50 transition-colors flex items-center gap-1 text-sm font-bold" onclick="formatSqlEditor()">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"/>
                </svg>
                æ ¼å¼åŒ–
            </button>
            <button id="btnMaximize" class="px-3 py-2 border border-slate-300 text-amber-600 rounded-lg hover:bg-amber-50 transition-colors flex items-center gap-1 text-sm font-bold" onclick="toggleSqlEditorMaximize()" title="å€åŸŸæœ€å¤§åŒ–">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5l-5-5m5 5v-4m0 4h-4"/>
                </svg>
                æœ€å¤§åŒ–
            </button>
            <button id="btnShrink" class="px-3 py-2 bg-slate-100 text-slate-700 border border-slate-300 rounded-lg hover:bg-slate-200 transition-colors flex items-center gap-1 text-sm font-bold hidden" onclick="toggleSqlEditorMaximize()" title="é‚„åŸè¦–çª—">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
                é‚„åŸæ”¶ç¸®
            </button>
            <button class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors flex items-center gap-1 text-sm font-bold shadow-md" id="btnRunSql" onclick="runSql()">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                </svg>
                åŸ·è¡Œ (Run)
            </button>
        </div>
        <input type="file" id="sqlFileInput" accept=".sql,.txt" style="display: none;" onchange="loadSqlFile(event)">
    </div>

    <!-- SQL Editor -->
    <div id="sqlEditorWrapper" class="relative flex-1 flex flex-col min-h-[200px]">
        <textarea id="sqlEditor" class="hidden" style="display: none !important;"></textarea>
    </div>
</div>

<!-- Execution Results -->
<div id="execResultArea" class="mt-6 bg-white rounded-lg border border-slate-200 shadow-md p-6">
    <!-- Result Tabs -->
    <div class="flex gap-2 border-b border-slate-200 mb-4">
        <button class="px-4 py-2 text-sm font-bold border-b-2 border-blue-600 text-blue-600 transition-colors flex items-center gap-1"
                data-tab="res-msg" onclick="switchResultTab('res-msg')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            ğŸ’¬ è¨Šæ¯
        </button>
        <button class="px-4 py-2 text-sm font-bold border-b-2 border-transparent text-slate-600 hover:text-slate-900 transition-colors flex items-center gap-1"
                data-tab="res-grid" onclick="switchResultTab('res-grid')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v12m0 0l-4-4m4 4l4-4M3 15h18"/>
            </svg>
            ğŸ“Š è³‡æ–™ç¶²æ ¼
        </button>
        <button class="px-4 py-2 text-sm font-bold border-b-2 border-transparent text-slate-600 hover:text-slate-900 transition-colors flex items-center gap-1"
                data-tab="res-dbms" onclick="switchResultTab('res-dbms')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 15.536L9 21.071M15.536 9a6.5 6.5 0 11-9.192 9.192m9.192-9.192l6.071 6.071m-6.071-6.071L9 2.929"/>
            </svg>
            ğŸ“¢ DBMS è¼¸å‡º
        </button>
        <button class="px-4 py-2 text-sm font-bold border-b-2 border-transparent text-slate-600 hover:text-slate-900 transition-colors flex items-center gap-1"
                data-tab="res-script" onclick="switchResultTab('res-script')">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
            </svg>
            ğŸ“ åŸ·è¡Œè…³æœ¬è¼¸å‡º
        </button>
    </div>

    <!-- Tab Content -->
    <div class="min-h-80 space-y-4">
        <!-- Message Tab -->
        <div id="res-msg" class="tab-pane block">
            <div id="execStatusMsg" class="bg-blue-50 border border-blue-200 text-blue-800 p-4 rounded-lg flex items-center gap-3">
                <div id="execSpinner" class="hidden">
                    <svg class="w-5 h-5 text-blue-600 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                    </svg>
                </div>
                <span id="statusText" class="font-semibold">ç­‰å¾…æŒ‡ä»¤è¼¸å…¥...</span>
            </div>
        </div>

        <!-- Grid Tab -->
        <div id="res-grid" class="tab-pane hidden">
            <div id="gridPlaceholder" class="text-center text-slate-500 p-8">
                <svg class="w-16 h-16 mx-auto mb-3 opacity-25 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v12m0 0l-4-4m4 4l4-4M3 15h18"/>
                </svg>
                <p class="text-sm">éæŸ¥è©¢èªæ³•æˆ–å°šæœªåŸ·è¡ŒæŒ‡ä»¤ï¼Œç„¡å¯é¡¯ç¤ºè³‡æ–™</p>
            </div>
            <div id="execTableWrapper" class="hidden space-y-3">
                <div id="execSqlBadges" class="flex flex-wrap gap-2 items-center">
                    <!-- Badges injected by JS -->
                </div>
                <div class="flex justify-between items-center gap-4">
                    <!-- æœå°‹æ¡† -->
                    <div class="relative w-full max-w-xs">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>
                        <input type="text" id="execGridSearchInput"
                               class="block w-full pl-10 pr-3 py-2 border border-slate-300 rounded-lg text-sm placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all shadow-sm"
                               placeholder="æœå°‹çµæœå…§å®¹..."
                               onkeyup="filterExecGridTable()">
                    </div>
                    <div class="flex items-center gap-3">
                        <!-- æ¯é ç­†æ•¸ -->
                        <div class="flex items-center gap-2 text-sm text-slate-600">
                            <span class="whitespace-nowrap">æ¯é </span>
                            <select id="execPageSize" onchange="changeExecPageSize(this.value)"
                                    class="border border-slate-300 rounded-lg px-2 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 shadow-sm">
                                <option value="50">50</option>
                                <option value="100" selected>100</option>
                                <option value="200">200</option>
                                <option value="500">500</option>
                            </select>
                            <span class="whitespace-nowrap">ç­†</span>
                        </div>
                        <!-- åŒ¯å‡ºæŒ‰éˆ• -->
                        <button class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-bold flex items-center gap-2 transition-colors" onclick="exportGridToCSV()">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            åŒ¯å‡º CSV
                        </button>
                    </div>
                </div>
                <div id="execTableScrollArea" class="dba-table-wrapper overflow-auto rounded-lg border border-slate-200 max-h-[60vh] scrollbar-thin scrollbar-thumb-slate-300">
                    <table id="execDataTable" class="min-w-full text-sm dba-datatable">
                        <thead class="bg-blue-600 text-white sticky top-0 z-10"></thead>
                        <tbody class="divide-y divide-slate-200"></tbody>
                    </table>
                </div>
                <!-- åˆ†é æ§åˆ¶åˆ— -->
                <div id="execPagination" class="flex items-center justify-between gap-3 pt-1">
                    <div class="text-sm text-slate-500" id="execPaginationInfo"></div>
                    <div class="flex items-center gap-1">
                        <button id="btnExecFirstPage" onclick="goExecPage(1)"
                                class="px-2 py-1.5 rounded border border-slate-300 text-slate-600 hover:bg-blue-50 hover:border-blue-400 hover:text-blue-600 text-sm transition-colors" title="ç¬¬ä¸€é ">Â«</button>
                        <button id="btnExecPrevPage" onclick="goExecPage(window.execCurrentPage - 1)"
                                class="px-2 py-1.5 rounded border border-slate-300 text-slate-600 hover:bg-blue-50 hover:border-blue-400 hover:text-blue-600 text-sm transition-colors" title="ä¸Šä¸€é ">â€¹</button>
                        <div id="execPageNumbers" class="flex items-center gap-1"></div>
                        <button id="btnExecNextPage" onclick="goExecPage(window.execCurrentPage + 1)"
                                class="px-2 py-1.5 rounded border border-slate-300 text-slate-600 hover:bg-blue-50 hover:border-blue-400 hover:text-blue-600 text-sm transition-colors" title="ä¸‹ä¸€é ">â€º</button>
                        <button id="btnExecLastPage" onclick="goExecPage(window.execTotalPages)"
                                class="px-2 py-1.5 rounded border border-slate-300 text-slate-600 hover:bg-blue-50 hover:border-blue-400 hover:text-blue-600 text-sm transition-colors" title="æœ€å¾Œé ">Â»</button>
                        <span class="text-sm text-slate-500 ml-2">è·³è‡³</span>
                        <input type="number" id="execJumpPage" min="1"
                               class="w-16 px-2 py-1.5 border border-slate-300 rounded text-sm text-center focus:outline-none focus:ring-2 focus:ring-blue-500"
                               onkeydown="if(event.key==='Enter') goExecPage(parseInt(this.value))" placeholder="é ">
                        <button onclick="goExecPage(parseInt(document.getElementById('execJumpPage').value))"
                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm transition-colors">GO</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- DBMS Output Tab -->
        <div id="res-dbms" class="tab-pane hidden">
            <div id="dbmsOutputArea" class="bg-slate-900 text-slate-100 p-4 rounded-lg font-mono text-sm overflow-auto max-h-80 whitespace-pre-wrap break-words">-- å°šæœªæ•æ‰åˆ° DBMS_OUTPUT å…§å®¹ --</div>
        </div>

        <!-- Script Output Tab -->
        <div id="res-script" class="tab-pane hidden">
            <div id="scriptOutputArea" class="bg-slate-900 text-slate-100 p-4 rounded-lg font-mono text-sm overflow-auto max-h-80 whitespace-pre-wrap break-words">-- ç­‰å¾…åŸ·è¡Œç´€éŒ„ --</div>
        </div>
    </div>
</div>

<script>
function switchResultTab(tabId) {
    console.log('ğŸ”„ [switchResultTab] åˆ‡æ›åˆ°:', tabId);

    // Hide all tab panes (åªé¸æ“‡ execResultArea å…§ .min-h-80 å®¹å™¨ä¸‹çš„ .tab-pane)
    const tabContainer = document.querySelector('#execResultArea > .min-h-80');
    if (tabContainer) {
        tabContainer.querySelectorAll('.tab-pane').forEach(tab => {
            tab.classList.add('hidden');
        });
    }

    // Remove all active styles from tab buttons (åªé¸æ“‡ execResultArea å…§çš„æŒ‰éˆ•)
    const buttonContainer = document.querySelector('#execResultArea > .flex.gap-2');
    if (buttonContainer) {
        buttonContainer.querySelectorAll('[data-tab]').forEach(btn => {
            btn.classList.remove('border-blue-600', 'text-blue-600');
            btn.classList.add('border-transparent', 'text-slate-600', 'hover:text-slate-900');
        });
    }

    // Show selected tab
    const selectedTab = document.getElementById(tabId);
    if (selectedTab) {
        selectedTab.classList.remove('hidden');
        console.log('âœ… [switchResultTab] å·²é¡¯ç¤º tab:', tabId);
    } else {
        console.error('âŒ [switchResultTab] æ‰¾ä¸åˆ° tab:', tabId);
    }

    // Highlight selected button
    if (buttonContainer) {
        const selectedBtn = buttonContainer.querySelector(`[data-tab="${tabId}"]`);
        if (selectedBtn) {
            selectedBtn.classList.remove('border-transparent', 'text-slate-600', 'hover:text-slate-900');
            selectedBtn.classList.add('border-blue-600', 'text-blue-600');
            console.log('âœ… [switchResultTab] å·²é«˜äº®æŒ‰éˆ•:', tabId);
        }
    }

    // ç‰¹æ®Šè™•ç†ï¼šå¦‚æœåˆ‡æ›åˆ°è³‡æ–™ç¶²æ ¼ tabï¼Œæª¢æŸ¥æ˜¯å¦æœ‰è¡¨æ ¼è³‡æ–™
    if (tabId === 'res-grid') {
        const table = document.querySelector('#execDataTable tbody');
        const thead = document.querySelector('#execDataTable thead');
        // åªè¦æœ‰è³‡æ–™åˆ— OR æœ‰è¡¨é ­ï¼Œå°±è¦–ç‚ºæœ‰è³‡æ–™ (é¿å…å‰›å»ºç«‹è¡¨é ­ä½†å°šæœªå¡«å…¥è³‡æ–™æ™‚è¢«éš±è—)
        const hasData = (table && table.children.length > 0) || (thead && thead.querySelectorAll('th').length > 0);

        const gridPlaceholder = document.getElementById('gridPlaceholder');
        const tableWrapper = document.getElementById('execTableWrapper');

        console.log('ğŸ“Š [switchResultTab] è¡¨æ ¼è³‡æ–™:', {
            hasData,
            rowCount: table?.children.length,
            placeholderHidden: gridPlaceholder?.classList.contains('hidden'),
            wrapperHidden: tableWrapper?.classList.contains('hidden')
        });

        if (hasData) {
            // æœ‰è³‡æ–™ï¼šéš±è— placeholderï¼Œé¡¯ç¤ºè¡¨æ ¼
            gridPlaceholder?.classList.add('hidden');
            tableWrapper?.classList.remove('hidden');
            console.log('âœ… [switchResultTab] å·²é¡¯ç¤ºè¡¨æ ¼');
        } else {
            // ç„¡è³‡æ–™ï¼šé¡¯ç¤º placeholderï¼Œéš±è—è¡¨æ ¼
            gridPlaceholder?.classList.remove('hidden');
            tableWrapper?.classList.add('hidden');
            console.log('â„¹ï¸ [switchResultTab] é¡¯ç¤º placeholderï¼ˆç„¡è³‡æ–™ï¼‰');
        }
    }
}

/**
 * æœå°‹çµæœç¶²æ ¼
 */
</script>

<style>
    /* SQL ç·¨è¼¯å™¨å€åŸŸæœ€å¤§åŒ–æ¨£å¼ */
    #exec-pane {
        position: relative;
    }

    .sql-module-fullscreen {
        position: absolute !important;
        top: 0 !important;
        left: 0 !important;
        width: 100% !important;
        height: 100% !important;
        z-index: 50 !important;
        background: white !important;
        display: flex !important;
        flex-direction: column !important;
        padding: 1rem !important;
        box-sizing: border-box !important;
    }

    .sql-module-fullscreen .CodeMirror {
        flex: 1 !important;
        height: 100% !important;
        border-radius: 0.5rem !important;
        border: 1px solid #cbd5e1 !important;
        font-size: 1rem !important;
    }

    /* ç¢ºä¿ CodeMirror çš„å…§éƒ¨æ²å‹•å€åŸŸèˆ‡é‚Šæ¬„ä¹Ÿå¡«æ»¿ */
    .sql-module-fullscreen .CodeMirror-scroll,
    .sql-module-fullscreen .CodeMirror-sizer,
    .sql-module-fullscreen .CodeMirror-gutter {
        min-height: 100% !important;
    }
</style>
